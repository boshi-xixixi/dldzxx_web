<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Three.js Interactive Earth</title>
    <style>
        /* 页面样式重置，确保 Canvas 全屏 */
        body { margin: 0; overflow: hidden; background-color: #000; }
        canvas { display: block; } /* 移除 Canvas 默认边距 */
        
        /* UI 控件样式 */
        #ui-container {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.6);
            padding: 15px;
            border-radius: 8px;
            color: #fff;
            font-family: sans-serif;
            backdrop-filter: blur(4px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        .control-group { margin-bottom: 10px; }
        label { display: flex; align-items: center; gap: 8px; cursor: pointer; }
        
        /* 加载提示 */
        #loading {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            color: #00f3ff; font-family: monospace; font-size: 1.5rem;
            pointer-events: none; transition: opacity 0.5s;
        }
    </style>
    
    <!-- 引入 Import Map 用于解析 Three.js 模块 -->
    <script type="importmap">
        {
            "imports": {
                "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
                "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/"
            }
        }
    </script>
</head>
<body>
    <!-- 加载中文本 -->
    <div id="loading">SYSTEM INITIALIZING...</div>

    <!-- UI 控制面板 -->
    <div id="ui-container">
        <div class="control-group">
            <label>
                <input type="checkbox" id="autoRotateCheck" checked>
                自动旋转 (Auto Rotate)
            </label>
        </div>
        <div class="control-group">
            <small>左键拖拽旋转 | 右键拖拽平移 | 滚轮缩放</small>
        </div>
    </div>

    <!-- 主脚本逻辑 -->
    <script type="module">
        import * as THREE from 'three';
        import { OrbitControls } from 'three/addons/controls/OrbitControls.js';

        // ==========================================
        // 1. 配置参数 (Configuration)
        // ==========================================
        const CONFIG = {
            earthRadius: 5,          // 地球半径
            segments: 64,            // 球体细分精度
            rotationSpeed: 0.2,      // 旋转速度 (弧度/秒) - 用户要求 0.2/sec
            minZoom: 6,              // 最近缩放距离 (略大于半径)
            maxZoom: 20,             // 最远缩放距离
            textures: {
                // 使用高质量地球纹理 (来自 CDN)
                map: 'https://unpkg.com/three-globe/example/img/earth-blue-marble.jpg',      // 地表纹理
                bump: 'https://unpkg.com/three-globe/example/img/earth-topology.png',        // 地形凹凸纹理
                specular: 'https://unpkg.com/three-globe/example/img/earth-water.png'        // 海洋高光纹理
            },
            hotspot: {
                count: 50,           // 随机热点数量
                radius: 0.05,        // 热点半径 (用户要求 0.05)
                color: 0xff0000      // 热点颜色 (红色)
            }
        };

        // ==========================================
        // 2. 全局变量 (Global Variables)
        // ==========================================
        let scene, camera, renderer, controls;
        let earthMesh, hotspotGroup;
        let clock = new THREE.Clock(); // 用于计算时间差，保证旋转速度恒定
        let isAutoRotating = true;

        // ==========================================
        // 3. 初始化系统 (Initialization)
        // ==========================================
        init();
        animate();

        function init() {
            // --- A. 场景创建 ---
            scene = new THREE.Scene();
            // 使用黑色背景，模拟太空
            scene.background = new THREE.Color(0x050505); 
            
            // --- B. 相机配置 ---
            // 透视相机: 视场角 45度, 长宽比, 近裁剪面 0.1, 远裁剪面 1000
            camera = new THREE.PerspectiveCamera(45, window.innerWidth / window.innerHeight, 0.1, 1000);
            camera.position.set(0, 5, 12); // 初始视角位置

            // --- C. 渲染器配置 ---
            renderer = new THREE.WebGLRenderer({ 
                antialias: true, // 开启抗锯齿
                alpha: true      // 允许透明背景
            });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.setPixelRatio(window.devicePixelRatio); // 适配高分屏
            renderer.shadowMap.enabled = true; // 开启阴影计算
            renderer.shadowMap.type = THREE.PCFSoftShadowMap; // 柔和阴影
            document.body.appendChild(renderer.domElement);

            // --- D. 控制器配置 (OrbitControls) ---
            controls = new OrbitControls(camera, renderer.domElement);
            controls.enableDamping = true;      // 开启阻尼 (惯性滑动)
            controls.dampingFactor = 0.05;      // 阻尼系数
            controls.enablePan = true;          // 允许平移
            controls.enableZoom = true;         // 允许缩放
            controls.minDistance = CONFIG.minZoom; // 最小缩放限制
            controls.maxDistance = CONFIG.maxZoom; // 最大缩放限制
            // 注意: 我们手动处理自动旋转，不使用 controls.autoRotate，以便更精确控制速度

            // --- E. 灯光系统 (Lighting) ---
            setupLighting();

            // --- F. 创建地球 (Earth Object) ---
            createEarth();

            // --- G. 创建动态威胁热点 (Hotspots) ---
            createHotspots();

            // --- H. 事件监听 (Event Listeners) ---
            window.addEventListener('resize', onWindowResize);
            
            // UI 交互监听
            const autoRotateCheckbox = document.getElementById('autoRotateCheck');
            autoRotateCheckbox.addEventListener('change', (e) => {
                isAutoRotating = e.target.checked;
            });

            // 隐藏 Loading 提示
            setTimeout(() => {
                document.getElementById('loading').style.opacity = 0;
            }, 1000);
        }

        // ==========================================
        // 4. 功能函数实现 (Implementation Details)
        // ==========================================

        /**
         * 设置场景灯光
         * 包含环境光、主方向光(太阳)和背光
         */
        function setupLighting() {
            // 1. 环境光: 基础照明，防止背光面全黑
            const ambientLight = new THREE.AmbientLight(0x404040, 2); // 柔和白光
            scene.add(ambientLight);

            // 2. 方向光: 模拟太阳直射
            const sunLight = new THREE.DirectionalLight(0xffffff, 2.0);
            sunLight.position.set(50, 30, 50); // 光源位置
            sunLight.castShadow = true;        // 产生阴影
            
            // 优化阴影贴图质量
            sunLight.shadow.mapSize.width = 2048;
            sunLight.shadow.mapSize.height = 2048;
            
            scene.add(sunLight);

            // 3. 轮廓光: 增加地球边缘立体感 (蓝色调)
            const rimLight = new THREE.DirectionalLight(0x4455ff, 0.5);
            rimLight.position.set(-50, 0, -50); // 背面照射
            scene.add(rimLight);
        }

        /**
         * 创建地球 Mesh
         * 加载纹理并应用材质
         */
        function createEarth() {
            const textureLoader = new THREE.TextureLoader();
            
            // 加载纹理
            const mapTexture = textureLoader.load(CONFIG.textures.map);
            const bumpTexture = textureLoader.load(CONFIG.textures.bump);
            const specularTexture = textureLoader.load(CONFIG.textures.specular);

            // 地球几何体
            const geometry = new THREE.SphereGeometry(CONFIG.earthRadius, CONFIG.segments, CONFIG.segments);

            // 地球材质 (Phong 材质支持高光反射)
            const material = new THREE.MeshPhongMaterial({
                map: mapTexture,             // 颜色贴图
                bumpMap: bumpTexture,        // 凹凸贴图
                bumpScale: 0.15,             // 凹凸程度
                specularMap: specularTexture,// 高光贴图 (控制海洋反光)
                specular: new THREE.Color(0x333333), // 高光颜色
                shininess: 15                // 光泽度
            });

            earthMesh = new THREE.Mesh(geometry, material);
            earthMesh.castShadow = true;     // 投射阴影
            earthMesh.receiveShadow = true;  // 接收阴影
            scene.add(earthMesh);
        }

        /**
         * 经纬度转 3D 坐标 (Spherical -> Cartesian)
         * @param {number} lat 纬度 (-90 ~ 90)
         * @param {number} lng 经度 (-180 ~ 180)
         * @param {number} radius 半径
         * @returns {THREE.Vector3} 3D 空间坐标
         */
        function latLngToVector3(lat, lng, radius) {
            const phi = (90 - lat) * (Math.PI / 180);
            const theta = (lng + 180) * (Math.PI / 180);

            const x = -(radius * Math.sin(phi) * Math.cos(theta));
            const z = (radius * Math.sin(phi) * Math.sin(theta));
            const y = (radius * Math.cos(phi));

            return new THREE.Vector3(x, y, z);
        }

        /**
         * 创建随机分布的威胁热点
         */
        function createHotspots() {
            hotspotGroup = new THREE.Group();
            earthMesh.add(hotspotGroup); // 将热点组添加到地球，使其随地球旋转

            // 热点几何体 (小球)
            const geometry = new THREE.SphereGeometry(CONFIG.hotspot.radius, 16, 16);
            // 热点材质 (自发光红色)
            const material = new THREE.MeshBasicMaterial({ color: CONFIG.hotspot.color });

            for (let i = 0; i < CONFIG.hotspot.count; i++) {
                // 1. 生成随机经纬度
                // lat: -90 ~ 90, lng: -180 ~ 180
                // 避免极点 (lat 接近 90/-90)，稍微限制范围让分布更好看
                const lat = (Math.random() - 0.5) * 160; 
                const lng = (Math.random() - 0.5) * 360;

                // 2. 转换为 3D 坐标
                const position = latLngToVector3(lat, lng, CONFIG.earthRadius);

                // 3. 创建热点 Mesh
                const dot = new THREE.Mesh(geometry, material);
                dot.position.copy(position);
                
                // 4. 调整位置略微浮于表面，防止 Z-fighting (闪烁)
                dot.position.multiplyScalar(1.002); 

                hotspotGroup.add(dot);
            }
        }

        /**
         * 窗口大小改变时的响应处理
         */
        function onWindowResize() {
            // 更新相机长宽比
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            
            // 更新渲染器尺寸
            renderer.setSize(window.innerWidth, window.innerHeight);
        }

        // ==========================================
        // 5. 动画循环 (Animation Loop)
        // ==========================================
        function animate() {
            requestAnimationFrame(animate);

            const delta = clock.getDelta(); // 获取上一帧到当前帧的时间间隔 (秒)

            // 自动旋转逻辑
            if (isAutoRotating && earthMesh) {
                // 沿 Y 轴旋转
                // 速度: CONFIG.rotationSpeed (弧度/秒)
                earthMesh.rotation.y += CONFIG.rotationSpeed * delta;
            }

            // 更新控制器状态 (阻尼效果需要)
            controls.update();

            // 执行渲染
            renderer.render(scene, camera);
        }
    </script>
</body>
</html>